<h1>Developing Sources</h1>

<h3>Introduction</h3>
<p>
  <em>If you are migrating from <code>xjs@1.3.0</code> or lower, you may want to
  read about some <a href="tutorials.html#/sourceplugins#migration">important
  changes to sources</a>. This has affected our API for versions 1.4.0 and
  higher. Please make sure to also read about XSplit's new
  Source/Item Architecture below.</em>
</p>
<p>
  Sources are objects that may be added to your presentation. While XSplit does provide native source plugins such as cameras, games, and even RTMP streams,
  it is also possible to create your own source plugin using HTML. This page will
  be visible in your streams or recordings.
</p>
<p>
  To test your HTML plugin, simply drag the file onto the stage. Alternatively,
  if you are locally or remotely hosting the source, you may add the file by clicking Sources > Other > Webpage URL within XSplit Broadcaster.
</p>

<h3>Source/Item Architecture</h3>
<p>
  When talking about sources, it is important to understand the internal
  architecture in XSplit. Sources are rendered by one or more "video items".
  When you add a source to XSplit, a single video item is created by default.
</p>
<p>
  XSplit Broadcaster 2.8 includes the ability to convert a source into a global
  source. A global source is one that may be rendered by multiple items! Each
  item may have a different position, a different size, or even be located in
  different scenes.
</p>
<p>
  Because of the source/item architecture, some properties belong specifically
  to video items while others belong to the source. Source properties are
  actually shared across all video items rendering the source, while video item
  properties may be different for several video items for a given source. The
  following table contains a list of item properties exposed by <code>xjs</code>.
</p>

<table>
  <caption>Rendering Properties (for configuring a video item)</caption>
  <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
      <th>API Reference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name</td>
      <td>Modify the name of your item.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Item#setName">Item#setName<a></code></td>
    </tr>
    <tr>
      <td>cname</td>
      <td>Modify the custom name of the item.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Item#setCustomName">Item#setCustomName</a></code></td>
    </tr>
    <tr>
      <td>pos</td>
      <td>Set item position.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#setPosition">IItemLayout#setPosition</a></code></td>
    </tr>
    <tr>
      <td>crop</td>
      <td>Set item cropping.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#setCropping">IItemLayout#setCropping</a></code></td>
    </tr>
    <tr>
      <td>rotate</td>
      <td>Ability to rotate your items</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#getRotateX">IItemLayout#getRotateX</a></code>, and related rotation methods</td>
    </tr>
    <tr>
      <td>lockmove</td>
      <td>Set position locking to ON or OFF</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#isPositionLocked">IItemLayout#isPositionLocked</a></code></td>
    </tr>
    <tr>
      <td>keep_ar</td>
      <td>Keep aspect ratio of a video item</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#isKeepAspectRatio">IItemLayout#isKeepAspectRatio</a></code></td>
    </tr>
    <tr>
      <td>visible</td>
      <td>Checks if item is visible on stage.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemTransition#isVisible">IItemTransition#isVisible</a></code></td>
    </tr>
    <tr>
      <td>alpha</td>
      <td>Sets the transparency/opacity</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemColor#getTransparency">IItemColor#getTransparency</a></code></td>
    </tr>
    <tr>
      <td>border</td>
      <td>Set the border color of your Item</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemColor#getBorderColor">IItemColor#getBorderColor</a></code></td>
    </tr>
    <tr>
      <td>color correction/chroma key</td>
      <td>Set different chroma keying options for video items</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemChroma">IItemChroma</a></code> methods</td>
    </tr>
    <tr>
      <td>transition</td>
      <td>Set different transition options when visibility is toggled</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemTransition">IItemTransition</a></code> methods</td>
    </tr>
    <tr>
      <td>edgeeffect</td>
      <td>Sets the mask effect to any one of three possible choices: Shape/Edge effects, File masking, or None.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemEffect">IItemEffect</a></code> methods</td>
    </tr>
  </tbody>
</table>

<p>
  All other properties not listed above as a video item property is a source
  property. The following is a non-exhaustive list of source properties. (You
  might notice that most of the properties actually belong to some subclass of
  <code>Item</code>, but this is fine. If you configure a source property
  by giving a specific item's ID, the underlying call will actually bubble up to
  the appropriate source instead of the specified video item!)
</p>

<table>
  <caption>Examples of Source Properties</caption>
  <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
      <th>API Reference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>itemlist</td>
      <td>Gets the complete set of IDs for video items that are rendering this source.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Source#getItemList">Source#getItemList TODO need to also add this method to Source<a></code></td>
    </tr>
    <tr>
      <td>srcid</td>
      <td>Gets the ID for this source.</td>
      <td><code>TODO: TO BE IMPLEMENTED IN xjs</code></td>
    </tr>
    <tr>
      <td>globalsrc</td>
      <td>Toggles global source. (This is a special property. Check API docs for more details)</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Source#setGlobalSource">Source#setGlobalSource</a></code></td>
    </tr>
  </tbody>
</table>

<p>
  The following is a visual representation of what it means for a source to be
  global. A global source can be thought of as not existing in one specific
  scene; instead, it is only visible through its renderers (video items).
  Video items are in charge of a number of properties including position and
  transparency. The source is in charge of "global" source properties, which
  includes the source's configuration.
</p>

<img src="assets/globalsource.jpg">

<h3>Initializing Source Plugins</h3>
<p>
  Let's get right to some sample code!
</p>
<pre class="language-javascript"><code>// get necessary classes
var xjs = require('xjs');
var Item = xjs.Item;

// wait for the framework to finish initialization
xjs.ready()
  .then(Item.getItemList)
  .then(function(myItems) {
    // myItems is an array of all video items sharing the same source.
    // If the source is not a global source, then myItems will only contain one item.

    return myItems[0]; // gets the video item. You can now set its position, chroma key, etc.
  });</code></pre>
<p>
  For the most part, you can just stick with using <code>myItems[0]</code> and
  your plugin should work just fine. A common use case for the above pattern
  include letting the plugin take the entire size of the stage on
  initialization; because there is exactly one video item created when a user
  adds your plugin, your initialization code doesn't need to worry about
  multiple video items rendering your HTML source!
</p>
<p>
  To do more advanced initialization (such as loading of a more complex
  configuration for your source), please read about Configuration Objects here.
  TODO
</p>
<p>
  More advanced use cases such as extensions creating a global source and
  then creating and position new video items for that source may require
  awareness of the item list. For more information on extensions, see here. TODO
</p>

<h3>Configuration Objects</h3>
<p>
  A custom configuration object may also be applied to sources. Configuration
  objects are simple JSON objects that sources can save to memory.
  Configuration objects are primarily only meaningful to HTML sources and not
  others (such as image sources), but this includes plugins that you create!
</p>
<p>
  There are no standards prescribed for the configuration object; developers may
  use any valid JSON object. It is the responsibility of the source to load the
  saved object every time the source is loaded, and to apply the object's
  various settings onto the source's HTML. This is ideally done upon resolution
  of the framework's ready promise.
</p>
<p>
  In order to persist the configuration object for a specific source, you can
  use the <code><a href="http://xjsframework.github.io/api.html#/core/IItemConfig#saveConfig">IItemConfig#saveConfig</a></code>
  method on your item object (<code>myItems[0]</code> in the code snippet above.)
  As a standard practice, we suggest you allow users to configure your source
  through the source properties dialog. For more information on that, please
  have a look at this tutorial. TODO
</p>
<p>
  To get you started with loading your plugin's configuration, here's a code
  snippet.
</p>
<pre class="language-javascript"><code>var xjs = require('xjs');
var Item = xjs.Item;

xjs.ready()
  .then(Item.getItemList)
  .then(function(itemList) {
    return itemList[0];
  }).then(function(myItem) {
    // load any previously saved configuration
    return myItem.loadConfig();
  }).then(function(config) {
    // do some checking to see if we already have settings saved
    if (Object.keys(config) > 0) {
      // Load previous settings, based on the structure of your configuration object.
      // Note that if you already have saved settings, you probably shouldn't force
      // the default settings again, such as the default name of the source, or
      // whether your HTML page should occupy the entire mixer.
    } else {
      // Set initial item rendering settings here.
      myItem.setName('NewNameHere')
      .then(function(myItem) {
        // Property setters are chainable, so they resolve with same Item instance!
        // This means you can continue setting any properties.
        return myItem.setPosition(xjs.Rectangle.fromCoordinates(0, 0, 1, 1));
      }).then(function(myItem) {
        return myItem.setKeepAspectRatio(true);
      }).then(function(myItem) {
        // Continue initialization as necessary. We recommend saving a dummy
        // value in the configuration object to indicate that the defaults have
        // already been applied. If the user refreshes the source, you will
        // know not to override your user's position/size settings!
        myItem.saveConfig({
          defaultsLoaded: true
        });
      });
    }
  });</code></pre>

<h3>Source Plugin Window utility</h3>
<p>
  There is a utility class for source plugins which is used in conjunction with
  the source properties window. The <code>SourcePluginWindow</code> class is an
  Event Emitter. This class is used to detect any important events that sources
  are currently able to receive from the application. For example, a source that
  is kept loaded in memory may detect a scene change through the
  <code>scene-load</code> event emitted by <code>SourcePluginWindow</code>.
</p>
<p>One of its more important functions for fully-featured plugins is to save
  configuration objects when instructed by the source properties window. See this
  <a href="tutorials.html#/sourceconfig#man-config-obj" target="_blank">tutorial</a>
  for more details.
</p>

<h3><a id="migration">Migration notes</a></h3>
<p>
  Global sources were not yet implemented before XSplit Broadcaster 2.8. When it
  was released, we released <code>xjs@1.4.0</code> that aimed to provide a layer
  of compatibility with any old (pre-1.4.0) code.
</p>
<p>
  If you had worked with <code>xjs@1.3.0</code> or lower, please be informed of
  the following important changes:
</p>
<ol>
  <li>
  Old code required you to get the <code>Source</code> instance you are
  working with through <code>Source.getCurrentSource</code>. Since the
  sources are now clearly separated from the video items rendering them, you
  will need to do <code>Item.getItemList</code> instead, and take the first
  <code>Item</code> instance from there if you want to modify item properties
  such as position and layout.
  </li>
  <li>
  To preserve compatibility with older source code, the
  <code>Source.getCurrentSource</code> method is modified to return the first
  <code>Item</code> instance in the item list, when executed in XBC version
  2.8 or higher. We are also deprecating <code>Source.getCurrentSource</code>
  in favor of <code>Item.getItemList</code>.
  </li>
  <li>
  In the rare case when you might actually want to get the actual instance of
  <code>Source</code> instead of <code>Item</code> (for example, if you want to
  compare source IDs), a new method is available: <code>Source.getSource()</code>.
  That method gets the <code>Source</code> object for the executing HTML page.
  You may also get the <code>Source</code> object for a different, unrelated
  <code>Item</code> through <code>Item#getSource</code>.
  </li>
  <li>
  Despite how things such as your HTML plugin's configuration object is not
  tied to specific video items (they are tied to the HTML source because the
  renderer part has nothing to do with the configuration object), it is still
  safe to call <code>Item#saveConfig</code> on the items returned by the
  <code>Item.getItemList</code> method. This is because any non-item property
  accessor requests are bubbled up to the actual source.
  </li>
</ol>

