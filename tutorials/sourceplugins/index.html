<h1>Developing Sources</h1>

<h3>Introduction</h3>
<p>
  <em>If you are migrating from <code>xjs@1.3.0</code> or lower, you may want to
  read about some <a href="#migration">important changes to sources</a>. This has affected our API for versions 1.4.0 and higher.</em>
</p>
<p>
  Sources are objects that may be added to your presentation. While XSplit does provide native source plugins such as cameras, games, and even RTMP streams,
  it is also possible to create your own source plugin using HTML. This page will
  be visible in your streams or recordings.
</p>
<p>
  To test your HTML plugin, simply drag the file onto the stage. Alternatively,
  if you are locally or remotely hosting the source, you may add the file by clicking Sources > Other > Webpage URL within XSplit Broadcaster.
</p>

<h3>Source/Item Architecture</h3>
<p>
  When talking about sources, it is important to understand the internal
  architecture in XSplit. Sources are rendered by one or more "video items".
  When you add a source to XSplit, a single video item is created by default.
</p>
<p>
  XSplit Broadcaster 2.8 includes the ability to convert a source into a global
  source. A global source is one that may be rendered by multiple items! Each
  item may have a different position, a different size, or even be located in
  different scenes.
</p>
<p>
  Because of the source/item architecture, some properties belong specifically
  to video items while others belong to the source. Source properties are
  actually shared across all video items rendering the source, while video item
  properties may be different for several video items for a given source. The
  following table contains a list of item properties exposed by <code>xjs</code>.
</p>

<table>
  <caption>Rendering Properties (for configuring a video item)</caption>
  <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
      <th>API Reference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name</td>
      <td>Modify the name of your item.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Item#setName">item#setName<a></code></td>
    </tr>
    <tr>
      <td>cname</td>
      <td>Modify the custom name of the item.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Item#setCustomName">item#setCustomName</a></code></td>
    </tr>
    <tr>
      <td>pos</td>
      <td>Set item position.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#setPosition">IItemLayout#setPosition</a></code></td>
    </tr>
    <tr>
      <td>crop</td>
      <td>Set item cropping.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#setCropping">IItemLayout#setCropping</a></code></td>
    </tr>
    <tr>
      <td>rotate</td>
      <td>Ability to rotate your items</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#getRotateX">IItemLayout#getRotateX</a></code>, and related rotation methods</td>
    </tr>
    <tr>
      <td>lockmove</td>
      <td>Set position locking to ON or OFF</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#isPositionLocked">IItemLayout#isPositionLocked</a></code></td>
    </tr>
    <tr>
      <td>keep_ar</td>
      <td>Keep aspect ratio of a video item</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemLayout#isKeepAspectRatio">IItemLayout#isKeepAspectRatio</a></code></td>
    </tr>
    <tr>
      <td>visible</td>
      <td>Checks if item is visible on stage.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemTransition#isVisible">IItemTransition#isVisible</a></code></td>
    </tr>
    <tr>
      <td>alpha</td>
      <td>Sets the transparency/opacity</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemColor#getTransparency">IItemColor#getTransparency</a></code></td>
    </tr>
    <tr>
      <td>border</td>
      <td>Set the border color of your Item</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemColor#getBorderColor">IItemColor#getBorderColor</a></code></td>
    </tr>
    <tr>
      <td>color correction/chroma key</td>
      <td>Set different chroma keying options for video items</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemChroma">IItemChroma</a></code> methods</td>
    </tr>
    <tr>
      <td>transition</td>
      <td>Set different transition options when visibility is toggled</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemTransition">IItemTransition</a></code> methods</td>
    </tr>
    <tr>
      <td>edgeeffect</td>
      <td>Sets the mask effect to any one of three possible choices: Shape/Edge effects, File masking, or None.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/IItemEffect">IItemEffect</a></code> methods</td>
    </tr>
  </tbody>
</table>

<p>
  All other properties not listed above as a video item property is a source
  property. The following is a non-exhaustive list of source properties. (You
  might notice that most of the properties actually belong to some subclass of
  <code>Item</code>, but this is fine. If you configure a source property
  by giving a specific item's ID, the underlying call will actually bubble up to
  the appropriate source instead of the specified video item!)
</p>

<table>
  <caption>Examples of Source Properties</caption>
  <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
      <th>API Reference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>itemlist</td>
      <td>Gets the complete set of IDs for video items that are rendering this source.</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Item#getItemList">Item#getItemList<a></code></td>
    </tr>
    <tr>
      <td>srcid</td>
      <td>Gets the ID for this source.</td>
      <td><code>TODO: TO BE IMPLEMENTED IN xjs</td>
    </tr>
    <tr>
      <td>globalsrc</td>
      <td>Toggles global source. (This is a special property. Check API docs for more details)</td>
      <td><code><a href="http://xjsframework.github.io/api.html#/core/Item#setKeepLoaded">Item#setKeepLoaded</a></code></td>
    </tr>
  </tbody>
</table>

<h3>Initializing Source Plugins</h3>
<p>
  Let's get right to some sample code!
</p>
<pre class="language-javascript"><code>// get necessary classes
var xjs = require('xjs');
var Item = xjs.Item;

// wait for the framework to finish initialization
xjs.ready()
  .then(Item.getItemList)
  .then(function(myItems) {
    // myItems is an array of all video items sharing the same source.
    // If the source is not a global source, then myItems will only contain one item.

    return myItems[0]; // gets the video item. You can now set its position, chroma key, etc.
  });</code></pre>
<p>
  For the most part, you can just stick with using <code>myItems[0]</code> and
  your plugin should work just fine. A common use case for the above pattern
  include letting the plugin take the entire size of the stage on
  initialization; because there is exactly one video item created when a user
  adds your plugin, your initialization code doesn't need to worry about
  multiple video items rendering your HTML source!
</p>
<p>
  To do more advanced initialization (such as loading of a more complex
  configuration for your source), please check this tutorial. TODO
</p>
<p>
  More advanced use cases such as extensions creating a global source and
  then creating and position new video items for that source may require
  awareness of the item list. For more information on extensions, see here. TODO
</p>

<h3>Configuration Objects</h3>






<h3>Video Items and Sources</h3>
<p>An important concept in the underlying architecture of XSplit Broadcaster is the idea of sources and video items (the <code>Item</code> class in the framework.) The main difference between the two is that the source pertains to the base object that supplies the relevant stream of information to be displayed, while the item pertains to a renderer object that inherits some characteristics from the source.</p>
<p>In XSplit Broadcaster, the objects that you see in the stage are Items. Under the hood, each item simply renders whatever data is fed from the source (such as a camera feed, or a live stream, or the content from a web page). Any property change at the source level will reflect in all video items linked to that source. However, there are certain properties that belong only to an individual item: for example, items linked to the same source can all have different positions and cropping settings in the stage.</p>
<p><strong>Migration Notes:</strong> For developers using xjs@1.3.0 or older, you will notice that we previously used the <code>Source</code> subclasses to manipulate plugins. The reason why we had to separate the two entities right now is due to the introduction of Global Sources in XSplit Broadcaster 2.8, essentially allowing multiple items to share the same source even across scenes. xjs@1.4.0 contains a compatibility layer to allow your old code to continue working, but you should update the code as soon as possible to avoid problems.</p>
<h3>Sample code for manipulating Items</h3>
<pre class="language-javascript"><code>var xjs = require('xjs');

// For XBC version 2.8 and up
var Item = xjs.Item;

xjs.ready()
  .then(Item.getItemList)
  .then(function(myItems) {
    // myItems is an array of all video items sharing the same source.
    // If the source is not a global source, then myItems will only contain one item.
  });</code></pre>
<p><code>getItemList</code> returns the list of items that are rendering the web page source from where this function was called.</p>
<p><strong>Migration Notes:</strong> Developers using xjs@1.3.0 or older are familiar with getting the current <code>Source</code> object and manipulating its properties. However, we now strongly suggest using the <code>Item</code> to set properties instead. Any item-specific properties such as layout-oriented ones will be acquired only by that <code>Item</code> instance, but source-level property changes will actually be bubbled up from the video item to the source. For example, it is safe to call <code><a href="http://xjsframework.github.io/api.html#/core/IItemConfigurable#saveConfig">Item#saveConfig</a></code> to manipulate the webpage source's configuration object, and these changes will reflect in all items that are rendering that source. For more information on item-specific properties, please see the Renderer Properties section below.</p>
<h3>Sample code for manipulating Sources</h3>
<pre class="language-javascript"><code>// The Source class and related methods are now deprecated.
// While this sample code still works with xjs@1.4.0 and XBC 2.8, we suggest you migrate to using Items as in the sample code above.
var xjs = require('xjs');
// For XBC version 2.7 and lower
var Source = xjs.Source;

xjs.ready()
  .then(Source.getCurrentSource)
  .then(function(mySource) {
    // Do something with mySource here.
    // Note that this code does not work perfectly with XBC 2.8 Global Sources.
    // mySource actually refers to the first video item in the item list for this source.
  });</code></pre>
<h3>Initializing Source Plugins</h3>
<p>As a source plugin developer, you must take into account the user-definable settings like size, position, position locking, keeping loaded in memory and etc. Setting these properties only once (on initial add) is ideal, to prevent it from overwriting user-defined changes.</p>
<p>This can be done by checking the configuration of the source upon initialization. If the configuration is empty, this would mean that the source was just added into the scene. If not, then the source/item was already added to the stage and was just refreshed, the scene was reloaded or changed into, or XBC was just opened.</p>
<pre class="language-javascript"><code>var xjs = require('xjs');
var Item = xjs.Item;

xjs.ready()
  .then(Item.getItemList)
  .then(function(myItem) {
    return myItem.loadConfig();
  }).then(function(config) {
    if(Object.keys(config) > 0){
      //Load previous settings
    } else {
      //Set initial item rendering settings here
      myItem.setName('NewNameHere')
      .then(function(myItem) {
      // Promise resolves with same Item instance when name has been set
      })
    }
  });</code></pre>
  <p>This assumes that you are setting and saving predefined configurations on your source plugins. Additionally, these initial rendering properties would only work reliable when the source is not made global yet.</p>

  <p>It is also good to know that the Configuration Object that is being called by <code>loadConfig</code> is a Source-level property, which means you are calling the underlying source of the Item.</p>

<h3>Configuration objects</h3>
<p>
  Aside from the set of item-level properties (see the Renderer Properties section below), a custom configuration object may also be applied to sources. Configuration objects are simple JSON objects that sources can save to memory. Configuration objects are primarily only meaningful to HTML sources and not others (such as image sources), but this includes plugins that you create!
</p>
<p>
  There are no set values needed for the configuration object; developers may use any valid JSON object. It is the responsibility of the source to load the saved object every time the source is loaded, and to apply the object's various settings onto the source's HTML. This is ideally done upon resolution of the framework's ready promise.
</p>
<pre class="language-javascript"><code>var xjs = require('xjs');

// For XBC 2.8 and up, and xjs@1.4.0 or higher
var Item = xjs.Item;

xjs.ready()
  .then(Item.getItemList)
  .then(function(myItems) {
    // We want to get any item in the list of items linked to this web source.
    // The loadConfig() call bubbles up to the source because it is not a renderer-specific property.
    return myItems[0].loadConfig();
  }).then(function(config) {
    // apply the loaded configuration object onto the source
    // configuration may include things specific to your plugin, such as font color
  });

// For XBC 2.7 and lower, and xjs@1.3.0 and older
// Note that code below still works with XBC 2.8 and xjs@1.4.0 but migration is highly recommended
var Source = xjs.Source;

xjs.ready()
  .then(Source.getCurrentSource)
  .then(function(mySource) {
    return mySource.loadConfig();
  }).then(function(config) {
    // apply the loaded configuration object onto the item
  });
  </code></pre>
<p>
  To let the webpage source modify its own configuration, it simply needs to call <code>saveConfig()</code> on any <code>Item</code> instance rendering it.
</p>
<h3>Source Plugin Window utility</h3>
<p>
  There is a utility class for source plugins which is used in conjunction with the properties window. The <code>SourcePluginWindow</code> class is an Event Emitter. Currently, its only use to plugin developers is to save configuration objects as instructed by the properties window. See this <a href="tutorials.html#/sourceconfig#man-config-obj" target="_blank">section</a> for more details.
</p>



